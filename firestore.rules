/**
 * @file Firestore Security Rules for BIMCoach Studio
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model. Each user can only access
 * and modify data directly associated with their own user ID. This ensures data privacy
 * and prevents unauthorized access.
 *
 * @data_structure The data is organized hierarchically under the `/users/{userId}` collection.
 *  - User profiles are stored directly under `/users/{userId}`.
 *  - IFC models are stored in the `/users/{userId}/ifcModels/{ifcModelId}` subcollection.
 *  - Analysis results are stored in the `/users/{userId}/ifcModels/{ifcModelId}/analysisResults/{analysisResultId}` subcollection.
 *  - Chat messages are stored in the `/users/{userId}/messages/{messageId}` subcollection.
 *
 * @key_security_decisions
 *  - User listing is explicitly disallowed to prevent potential information leakage.
 *  - The default security posture for ambiguous relationships is strict owner-only access.
 *  - All write operations are protected by authorization checks to prevent unauthorized data modification.
 *
 * @denormalization_for_authorization
 *  - IFCModel documents include a `userId` field that is denormalized to match the parent `/users/{userId}` path.
 *    This allows for efficient ownership checks without requiring additional `get()` calls.
 *  - AnalysisResult documents include both `userId` (inherited from the parent IFCModel) and `ifcModelId` fields for similar reasons.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles, allowing only the owner to read and write their own data.
     * @path /users/{userId}
     * @allow (get, create, update, delete) User with UID 'user123' can read/write their own profile.
     * @deny (get, create, update, delete) User with UID 'user456' cannot read/write 'user123' profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the request is made by the owner.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Read rules
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not allowed

      // Write rules
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure IFC models, allowing only the owner to read and write their own models.
     * @path /users/{userId}/ifcModels/{ifcModelId}
     * @allow (get, create, update, delete) User with UID 'user123' can read/write their own IFC model with ID 'ifc123'.
     * @deny (get, create, update, delete) User with UID 'user456' cannot read/write 'user123' IFC model.
     * @principle Enforces document ownership for all operations, validates relational integrity on create.
     */
    match /users/{userId}/ifcModels/{ifcModelId} {

      // Helper function to check if the request is made by the owner.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the resource exists and the owner is valid.
      function isExistingOwner(userId) {
          return request.auth != null && request.auth.uid == userId && resource != null;
      }

      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure analysis results, allowing only the owner to read and write their own results.
     * @path /users/{userId}/ifcModels/{ifcModelId}/analysisResults/{analysisResultId}
     * @allow (get, create, update, delete) User with UID 'user123' can read/write their own analysis result with ID 'analysis123'.
     * @deny (get, create, update, delete) User with UID 'user456' cannot read/write 'user123' analysis result.
     * @principle Enforces document ownership for all operations, validates relational integrity on create.
     */
    match /users/{userId}/ifcModels/{ifcModelId}/analysisResults/{analysisResultId} {
        // Helper function to check if the request is made by the owner.
        function isOwner(userId) {
            return request.auth != null && request.auth.uid == userId;
        }

        // Helper function to check if the resource exists and the owner is valid.
        function isExistingOwner(userId) {
            return request.auth != null && request.auth.uid == userId && resource != null;
        }

        // Read rules
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);

        // Write rules
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure chat messages, allowing only the owner to read and write their own messages.
     * @path /users/{userId}/messages/{messageId}
     * @allow (get, create, update, delete) User with UID 'user123' can read/write their own message with ID 'message123'.
     * @deny (get, create, update, delete) User with UID 'user456' cannot read/write 'user123' message.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/messages/{messageId} {
      // Helper function to check if the request is made by the owner.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the resource exists and the owner is valid.
      function isExistingOwner(userId) {
        return request.auth != null && request.auth.uid == userId && resource != null;
      }

      // Read rules
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // Write rules
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}